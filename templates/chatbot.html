{% extends "base.html" %}
{% block title %}Chatbot - Prolet{% endblock %}
{% block content %}
<!-- âœ… CHECK LOGIN STATUS & SHOW WELCOME MESSAGE -->
<div id="userWelcome" style="text-align: center; margin: 1rem 0; font-weight: 600; color: #2c3e50; font-size: 1.1rem;"></div>

<div class="tone-selector">
  <label><input type="radio" name="tone" value="auto" checked> Auto</label>
  <label><input type="radio" name="tone" value="formal"> Formal</label>
  <label><input type="radio" name="tone" value="informal"> Informal</label>
</div>

<div class="chat-input">
  <input type="text" id="userInput" placeholder="Describe your letter needs..." />
  <button onclick="generateLetter()" style="background: #4a6fa5; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 30px; cursor: pointer; font-weight: 600; transition: background 0.3s;">
  Generate Letter
</button>
  <button id="regenerateBtn" onclick="regenerateLetter()" style="display: none; background: #6c5ce7; color: white; padding: 0.75rem; border: none; border-radius: 6px; cursor: pointer; margin-left: 0.5rem;">
    ğŸ”„ Regenerate
  </button>
</div>  

<div id="letterOutput">
  <!-- Hidden printable version for PDF -->
  <div id="printableLetter" style="display: none; padding: 40px; width: 210mm; font-family: 'Georgia', serif; line-height: 1.6; font-size: 12pt; color: #000;">
    <pre id="printableContent"></pre>
  </div>

  <!-- Visible letter display -->
  <div class="letter-container">
    <div id="letterContent">Your letter will appear here...</div>
  </div>

  <!-- Email section -->
  <div id="emailSection" style="text-align: center; margin: 1.5rem 0; display: none;">
  <input type="email" id="emailInput" placeholder="Enter recipient email"
         style="padding: 8px; width: 250px; margin-right: 8px; border: 1px solid #ccc; border-radius: 4px;">

  <button onclick="sendEmail()"
          style="padding: 8px 12px; background: #4a6fa5; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
    ğŸ“§ Send Email
  </button>

  <style>
  #emailSection button:hover {
    background: #2c3e50;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  </style>
</div>

  <!-- Action buttons -->
  <div id="letterActions">
    <button id="copyBtn" onclick="copyLetter()" title="Copy to clipboard">ğŸ“‹</button>
    <button onclick="downloadPDF()" title="Download as PDF">ğŸ“„</button>
    <button onclick="saveDraft()" title="Save Draft">ğŸ’¾</button>
    <button id="printBtn" onclick="window.print()" title="Print letter">ğŸ–¨ï¸</button>
  </div>
</div>

<script>
// âœ… CHECK LOGIN STATUS (Server-Side)
(function() {
  // Jinja2 renders this on the server
  const userEmail = "{{ session.user_email }}";
  if (!userEmail || userEmail === "None") {
    alert("âš ï¸ Please log in to use the chatbot.");
    window.location.href = "/login";
    return;
  }
  // Get first name from server (via Jinja2)
const firstName = "{{ session.first_name }}";
if (firstName && firstName !== "None") {
  document.getElementById('userWelcome').textContent = `Welcome, ${firstName}!`;
} else {
  // Fallback: Show email if no first name
  const userEmail = "{{ session.user_email }}";
  document.getElementById('userWelcome').textContent = `Welcome, ${userEmail}!`;
}
})();
// âœ… MEMORY FOR REGENERATE
let lastPrompt = null;

// âœ… COPY FUNCTION
function copyLetter() {
  const letterElement = document.getElementById('letterContent');
  if (!letterElement) {
    alert("âŒ Letter not found!");
    return;
  }
  const text = letterElement.textContent;
  if (!text || text.includes("Your letter will appear")) {
    alert("âš ï¸ Please generate a letter first.");
    return;
  }
  navigator.clipboard.writeText(text).then(() => {
    document.getElementById('copyBtn').innerHTML = "âœ…";
    setTimeout(() => document.getElementById('copyBtn').innerHTML = "ğŸ“‹", 1500);
  }).catch(() => fallbackCopy(text));
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
  document.getElementById('copyBtn').innerHTML = "âœ…";
  setTimeout(() => document.getElementById('copyBtn').innerHTML = "ğŸ“‹", 1500);
}

// âœ… DOWNLOAD PDF
async function downloadPDF() {
  const letterText = document.getElementById('letterContent').textContent;
  if (!letterText || letterText.trim() === "Your letter will appear here..." || letterText.includes("Generating")) {
    alert("Please generate a letter first.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');

  pdf.setFont('Georgia', 'normal');
  pdf.setFontSize(12);
  pdf.setTextColor(0, 0, 0);

  const leftMargin = 20;
  const topMargin = 20;
  const pageWidth = 170;
  let y = topMargin;

  // Header
  pdf.setFontSize(14);
  pdf.setFont('Georgia', 'bold');
  pdf.text("Prolet Letter", leftMargin, y);
  y += 10;
  pdf.setFont('Georgia', 'normal');
  pdf.setFontSize(12);

  const paragraphs = letterText.split('\n');
  for (const paragraph of paragraphs) {
    if (y > 280) {
      pdf.addPage();
      y = topMargin;
    }
    if (paragraph.trim() === "") {
      y += 6;
      continue;
    }
    const wrappedLines = pdf.splitTextToSize(paragraph, pageWidth);
    for (const line of wrappedLines) {
      if (y > 280) {
        pdf.addPage();
        y = topMargin;
      }
      pdf.text(line, leftMargin, y);
      y += 7;
    }
    y += 4;
  }
  pdf.save('prolet_letter.pdf');
}

// âœ… GENERATE LETTER (WITH MEMORY)
async function generateLetter() {
  const msg = document.getElementById('userInput').value.trim();
  if (!msg) { 
    alert("Please describe your letter needs."); 
    return; 
  }
  const tone = document.querySelector('input[name="tone"]:checked').value;
  
  // Save prompt for regenerate
  lastPrompt = { message: msg, tone: tone };

  document.getElementById('letterContent').textContent = "Generating your letter...";
  document.getElementById('letterOutput').style.display = "block";
  document.getElementById('regenerateBtn').style.display = "none";

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(lastPrompt)
    });
    const data = await res.json();
    if (data.reply) {
      document.getElementById('letterContent').textContent = data.reply;
      document.getElementById('letterActions').style.display = "flex";
      document.getElementById('emailSection').style.display = "block";
      document.getElementById('regenerateBtn').style.display = "inline-block";
    } else {
      document.getElementById('letterContent').textContent = "Sorry, I couldn't generate a letter.";
    }
  } catch (err) {
    document.getElementById('letterContent').textContent = "Connection error.";
  }
}

// âœ… REGENERATE LETTER
async function regenerateLetter() {
  if (!lastPrompt) {
    alert("No letter to regenerate. Please generate one first.");
    return;
  }

  document.getElementById('letterContent').textContent = "Regenerating your letter...";
  document.getElementById('regenerateBtn').style.display = "none";

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(lastPrompt)
    });
    const data = await res.json();
    if (data.reply) {
      document.getElementById('letterContent').textContent = data.reply;
      document.getElementById('regenerateBtn').style.display = "inline-block";
    } else {
      document.getElementById('letterContent').textContent = "Sorry, I couldn't regenerate the letter.";
    }
  } catch (err) {
    document.getElementById('letterContent').textContent = "Connection error.";
  }
}

async function sendEmail() {
  const email = document.getElementById('emailInput').value.trim();
  const letter = document.getElementById('letterContent').textContent;
  const button = document.querySelector('#emailSection button');

  if (!email) {
    alert("Please enter a recipient email.");
    return;
  }
  if (!letter || letter.includes("Your letter will appear")) {
    alert("Please generate a letter first.");
    return;
  }

  // âœ… SHOW LOADING STATE
  const originalText = button.innerHTML;
  button.innerHTML = "ğŸ“§ Sending...";
  button.disabled = true;
  button.style.opacity = "0.8";
  button.style.cursor = "not-allowed";

  try {
    const res = await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: email, letter: letter })
    });
    const data = await res.json();
    
    if (data.success) {
      button.innerHTML = "âœ… Sent!";
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = "1";
        button.style.cursor = "pointer";
      }, 2000);
    } else {
      button.innerHTML = "âŒ Failed";
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        button.style.opacity = "1";
        button.style.cursor = "pointer";
      }, 2000);
      alert("âŒ " + (data.error || "Failed to send email."));
    }
  } catch (err) {
    button.innerHTML = "âŒ Error";
    setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;
      button.style.opacity = "1";
      button.style.cursor = "pointer";
    }, 2000);
    alert("Failed to connect to server.");
  }
}

// âœ… SAVE DRAFT
function saveDraft() {
  const letter = document.getElementById('letterContent').textContent;
  if (!letter || letter.includes("Your letter will appear")) {
    alert("âš ï¸ Please generate a letter first.");
    return;
  }
  const title = prompt("Draft title:", "My Letter");
  if (!title) return;
  
  const drafts = JSON.parse(localStorage.getItem('prolet_drafts') || '[]');
  drafts.push({ title, content: letter, date: new Date().toISOString() });
  localStorage.setItem('prolet_drafts', JSON.stringify(drafts));
  alert("âœ… Draft saved to your browser!");
}
</script>
{% endblock %}